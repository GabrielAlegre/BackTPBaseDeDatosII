const Ticket = require('../models/ticketModel');

//GET - TRAER TODOS LOS TICKETS
exports.traerTickets = async (req, res) => {
  try {
    const tickets = await Ticket.find({});
    res.status(200).json(tickets);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// GET - TRAER TICKETS PENDIENTES ($eq)
exports.traerTicketsPendientes = async (req, res) => {
  try {
    const ticketsPendientes = await Ticket.find({ estado: { $eq: "pendiente" } });
    res.status(200).json(ticketsPendientes);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// GET - TRAER TICKETS NO PENDIENTES ($ne)
exports.traerTicketsNoPendientes = async (req, res) => {
  try {
    const ticketsNoPendientes = await Ticket.find({ estado: { $ne: "pendiente" } });
    res.status(200).json(ticketsNoPendientes);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// GET - TRAER TICKETS PENDIENTES DE TIPO ALTA ($and)
exports.traerTicketsPendientesYTipoEspecifico = async (req, res) => {
  try {
    const ticketsPendientesYTipoEspecifico = await Ticket.find({
      $and: [
        { estado: "pendiente"},
        { "detalleTicket.tipoDeTicket": "dar de alta" }
      ]
    });

    res.status(200).json(ticketsPendientesYTipoEspecifico);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};


// GET - TRAER TICKETS RESUELTOS O DE TIPO BAJA ($or)
exports.traerTicketsResueltosOTipoEspecifico = async (req, res) => {
  try {
    const ticketsResueltosOTipoEspecifico = await Ticket.find({
      $or: [
        { estado: "resuelto" },
        { "detalleTicket.tipoDeTicket": "dar de baja" }
      ]
    });

    res.status(200).json(ticketsResueltosOTipoEspecifico);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// GET - TRAER TICKETS CON CÓDIGO DE EMPLEADO MAYOR A UN VALOR DETERMINADO ($gt)
exports.traerTicketsCodigoEmpleadoMayor = async (req, res) => {
  try {
    const codigoEmpleadoLimite = 12000; // Ajusta el valor según tus necesidades

    const ticketsCodigoEmpleadoMayor = await Ticket.find({
      "detalleTicket.empleadoResponsableQueAtendioElTicket.codigoEmpleado": { $gt: codigoEmpleadoLimite }
    });
    res.status(200).json(ticketsCodigoEmpleadoMayor);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar tickets que no estén resueltos ni tengan un código de empleado mayor o igual a 12000 ($nor y $gte)
exports.traerTicketsNoResueltosNiCodigoEmpleadoMayor = async (req, res) => {
  try {
    const codigoEmpleadoLimite = 12000;
    const ticketsNoResueltosNiCodigoEmpleadoMayor = await Ticket.find({
      $nor: [
        { estado: "resuelto" },
        { "detalleTicket.empleadoResponsableQueAtendioElTicket.codigoEmpleado": { $gte: codigoEmpleadoLimite } }
      ]
    });
    res.status(200).json(ticketsNoResueltosNiCodigoEmpleadoMayor);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}


//GET - Encontrar tickets que tengan numero de canales menores a 200 ($lt)
exports.traerTicketsNumeroPlanMenoresDocientos = async (req, res) => {
  try {
    const cantidadMaximaCanales = 200;

    const ticketsConPlanMenorCanales = await Ticket.find({
      "clienteInfo.plan.canales": { $lt: cantidadMaximaCanales }
    });

    res.status(200).json(ticketsConPlanMenorCanales);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar tickets que tengan numero de canales menores o iguales a 213 ($lte)
exports.traerTicketsNumeroPlanMenoresIgual = async (req, res) => {
  try {
    const cantidadMaximaCanales = 213;

    const ticketsConPlanMenorCanales = await Ticket.find({
      "clienteInfo.plan.canales": { $lte: cantidadMaximaCanales }
    });

    res.status(200).json(ticketsConPlanMenorCanales);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar tickets con beneficios "HBO Max", "Paramount+" ($all)
exports.traerTicketsConTodosBeneficios = async (req, res) => {
  try {
    const beneficiosRequeridos = ["HBO Max", "Paramount+"];

    const ticketsConTodosBeneficios = await Ticket.find({
      "clienteInfo.plan.beneficios": { $all: beneficiosRequeridos }
    });

    res.status(200).json(ticketsConTodosBeneficios);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar tickets cuyos clientes tengan correo ($exists)
exports.traerTicketsConCorreos = async (req, res) => {
  try {
    const ticketsConCorreos = await Ticket.aggregate([
      {
        $lookup: {
          from: "clientes",
          localField: "clienteInfo.dni",
          foreignField: "dni",
          as: "clienteInfoExtendido"
        }
      },
      {
        $unwind: "$clienteInfoExtendido"
      },
      {
        $match: {
          "clienteInfoExtendido.correos": { $exists: true, $ne: [] }
        }
      }
    ]);

    res.status(200).json(ticketsConCorreos);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}


//GET - Encontrar tickets que contengan la palabra "alta" en la descripción del problema ($search, $text)
exports.traerTicketsPorTexto = async (req, res) => {
  try {
    const palabraBusqueda = "alta";

    const ticketsPorTexto = await Ticket.find({
      $text: { $search: palabraBusqueda }
    });

    res.status(200).json(ticketsPorTexto);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar tickets que tengan una derivacion ($size)
exports.traerTicketsConNumeroDerivaciones = async (req, res) => {
  try {
    const cantidadDerivacionesBuscada = 1;

    const ticketsConNumeroDerivaciones = await Ticket.find({
      Derivaciones: { $size: cantidadDerivacionesBuscada }
    });

    res.status(200).json(ticketsConNumeroDerivaciones);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//GET - Encontrar la cantidad Total de Beneficios ($unwind, $group)
exports.obtenerTotalBeneficios = async (req, res) => {
  try {
    const totalBeneficios = await Ticket.aggregate([
      { $unwind: "$clienteInfo.plan.beneficios" },
      { $group: { _id: null, total: { $sum: 1 } } }
    ]);

    res.status(200).json(totalBeneficios);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

// tickets Pendientes con Código de Empleado Mayor a un Valor Específico ($match, $project)
exports.traerTicketsPendientesConEmpleadoMayor = async (req, res) => {
  try {
    const codigoEmpleadoLimite = 12000;

    const ticketsPendientesConEmpleadoMayor = await Ticket.aggregate([
      {
        $match: {
          estado: "pendiente",
          "detalleTicket.empleadoResponsableQueAtendioElTicket.codigoEmpleado": { $gt: codigoEmpleadoLimite }
        }
      },
      {
        $project: {
          _id: 1,
          tipoDeTicket: "$detalleTicket.tipoDeTicket",
          clienteNombre: "$clienteInfo.nombre",
          estado: 1,
          descripcionProblema: "$detalleTicket.detalleDelProblema.descripcion",
          codigoEmpleadoResponsable: "$detalleTicket.empleadoResponsableQueAtendioElTicket.codigoEmpleado",
          nombreEmpleadoResponsable: "$detalleTicket.empleadoResponsableQueAtendioElTicket.nombre"
        }
      }
    ]);

    res.status(200).json(ticketsPendientesConEmpleadoMayor);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.traerTicketsConClientesEmpleados = async (req, res) => {
  try {
    const ticketsConClientesEmpleados = await Ticket.aggregate([
      {
        $lookup: {
          from: "clientes",
          localField: "clienteInfo.dni",
          foreignField: "dni",
          as: "clienteInfoExtendido"
        }
      },
      {
        $unwind: "$clienteInfoExtendido"
      },
      {
        $match: {
          "clienteInfoExtendido.esEmpleado": true
        }
      }
    ]);

    res.status(200).json(ticketsConClientesEmpleados);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

exports.traerTicketsGeoIntersect = async (req, res) => {
  try {
    const regionEspecifica = {
      type: "Polygon",
      coordinates: [
        [
          [-58.4, -34.7],
          [-58.4, -34.6],
          [-58.2, -34.6],
          [-58.2, -34.7],
          [-58.4, -34.7]
        ]
      ]
    };

    const ticketsIntersectanRegion = await Ticket.find({
      "clienteInfo.ubicacion.coordinates": {
        $geoIntersects: {
          $geometry: regionEspecifica
        }
      }
    });

    res.status(200).json(ticketsIntersectanRegion);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
}

//Buscar tickets que tengan una derivacion al departamento de cancelaciones y la solucion fue exitosa
exports.traerTicketsDepCancelacionesSolucionExitosa = async (req, res) => {
  try {
    const ticketsConDerivacionExitosa = await Ticket.find({
      Derivaciones: {
        $elemMatch: {
          departamento: "Departamento de Cancelaciones",
          "solucion.exito": true
        }
      }
    });

    res.status(200).json(ticketsConDerivacionExitosa);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

//Buscar los tickets cuyas ubicaciones estén dentro de un radio específico alrededor de Mar del Plata
exports.obtenerTicketsAlrededorDeMardel = async (req, res) => {
  try {
    const coordenadasGeoWithinMardel = [-57.559494950533775, -38.00772570972944];//mardel
    const radioEnKilometros = 10;

    const ticketsEnAreaMardel = await Ticket.find({
      "clienteInfo.ubicacion.coordinates": {
        $geoWithin: {
          $centerSphere: [coordenadasGeoWithinMardel, radioEnKilometros / 6371], // radianes
        },
      },
    });

    res.status(200).json(ticketsEnAreaMardel);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};


